{% extends "layout.html" %}

{% block content %}
<style>
  /* åªå½±å“æé†’é¢æ¿è¿™ä¸ªé¡µé¢ */
  .alerts-page {
    max-width: 960px;
    margin: 16px auto 24px;
    padding: 0 12px 24px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: #111827;
  }

  .alerts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }

  .alerts-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .alerts-badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    background: #ecfdf3;
    color: #15803d;
    border: 1px solid #bbf7d0;
  }

  .alerts-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }

  .btn {
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 500;
    border: 1px solid transparent;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #fff;
    color: #111827;
    text-decoration: none;
  }

  .btn-primary {
    background: #2563eb;
    border-color: #2563eb;
    color: #fff;
  }

  .btn-ghost {
    border-color: #d1d5db;
    background: #fff;
    color: #4b5563;
  }

  .btn[disabled] {
    opacity: 0.6;
    cursor: default;
  }

  .btn-icon {
    font-size: 14px;
    line-height: 1;
  }

  .btn-sm {
    padding: 4px 10px;
    font-size: 12px;
  }

  /* ç­›é€‰å¡ç‰‡ */
  .filter-card {
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    padding: 10px 12px;
    margin-bottom: 10px;
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
  }

  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1 1 140px;
    min-width: 0;
  }

  .filter-label {
    font-size: 12px;
    color: #6b7280;
  }

  .filter-input input[type="date"],
  .filter-input input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 13px;
    outline: none;
  }

  .filter-input input[type="date"]:focus,
  .filter-input input[type="number"]:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
  }

  .filter-actions {
    display: flex;
    flex-wrap: nowrap;
    gap: 6px;
    align-items: flex-end;
  }

  /* ç®€è¦ç»Ÿè®¡ï¼šç«–ç›´ä¸€åˆ—ï¼Œé€‚åˆæ‰‹æœº */
  .summary-row {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
  }

  .summary-card {
    width: 100%;
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    padding: 8px 10px;
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
  }

  .summary-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 2px;
  }

  .summary-value {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
  }

  .summary-pill {
    display: inline-block;
    font-size: 11px;
    padding: 1px 6px;
    border-radius: 999px;
    margin-left: 6px;
    border: 1px solid #d1d5db;
    color: #4b5563;
    background: #f9fafb;
  }

  .summary-pill.danger {
    border-color: #f97373;
    background: #fef2f2;
    color: #b91c1c;
  }

  .summary-pill.safe {
    border-color: #22c55e;
    background: #ecfdf3;
    color: #15803d;
  }

  /* è¡¨æ ¼å¡ç‰‡ */
  .table-card {
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    padding: 10px 12px 8px;
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
    margin-top: 10px;
  }

  .table-title {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 6px;
    color: #111827;
  }

  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    min-width: 640px;
  }

  thead th {
    text-align: left;
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #6b7280;
    white-space: nowrap;
  }

  tbody td {
    padding: 6px 8px;
    border-bottom: 1px solid #f3f4f6;
    white-space: nowrap;
  }

  tbody tr:nth-child(odd) {
    background: #ffffff;
  }

  tbody tr:nth-child(even) {
    background: #f9fafb;
  }

  tbody tr:hover {
    background: #e5f0ff;
  }

  td.amount {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 8px;
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #374151;
  }

  .pill-market {
    background: #eff6ff;
    border-color: #bfdbfe;
    color: #1d4ed8;
  }

  .pill-number {
    background: #fffbeb;
    border-color: #facc15;
    color: #92400e;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.04em;
  }

  .pill-small {
    background: #eef2ff;
    border-color: #c7d2fe;
    color: #4338ca;
  }

  .amount-strong {
    font-weight: 600;
    color: #065f46;
  }

  .amount-strong.danger {
    color: #b91c1c;
  }

  .empty-state {
    padding: 18px 8px 10px;
    text-align: center;
    font-size: 13px;
    color: #6b7280;
  }

  .empty-icon {
    font-size: 20px;
    margin-bottom: 4px;
  }

  @media (max-width: 640px) {
    .alerts-page {
      padding: 0 10px 20px;
    }
    .alerts-header {
      align-items: flex-start;
    }
    .alerts-actions {
      width: 100%;
      justify-content: flex-end;
    }
    .filter-card {
      padding: 10px;
    }
  }
</style>

<div class="alerts-page">
  <header class="alerts-header">
    <h1 class="alerts-title">
      é¢„è®¡ä¸­å¥–æé†’é¢æ¿
      <span class="alerts-badge">Admin Only</span>
    </h1>
    <div class="alerts-actions">
      <a href="{{ url_for('index') }}" class="btn btn-ghost">
        <span class="btn-icon">â†</span> è¿”å›ä¸»é¡µ
      </a>
    </div>
  </header>

  <!-- ç­›é€‰åŒºåŸŸ -->
  <section class="filter-card">
    <form method="get" action="{{ url_for('admin_alerts') }}">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">å¼€å¥–æ—¥æœŸ</label>
          <div class="filter-input">
            <input type="date" name="date" value="{{ selected_date }}" required>
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">æé†’é˜ˆå€¼ (RM)</label>
          <div class="filter-input">
            <input type="number" name="threshold" min="0" step="100" value="{{ threshold }}">
          </div>
        </div>

        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">
            <span class="btn-icon">ğŸ”</span> æŸ¥è¯¢
          </button>
          <a href="{{ url_for('admin_alerts') }}" class="btn btn-ghost">
            ä»Šå¤©
          </a>
        </div>
      </div>
    </form>
  </section>

  <!-- ç®€è¦ç»Ÿè®¡ï¼ˆç«–ç›´ä¸€åˆ—ï¼‰ -->
  <section class="summary-row">
    <div class="summary-card">
      <div class="summary-label">åŒ¹é…æ—¥æœŸæ³¨å•æ•°</div>
      <div class="summary-value">{{ total_bets }}</div>
    </div>

    <div class="summary-card">
      <div class="summary-label">
        é£é™©å·ç 
        {% if alerts|length > 0 %}
          <span class="summary-pill danger">æœ‰é£é™©</span>
        {% else %}
          <span class="summary-pill safe">å®‰å…¨</span>
        {% endif %}
      </div>
      <div class="summary-value">{{ alerts|length }}</div>
    </div>

    <div class="summary-card">
      <div class="summary-label">å½“å‰æé†’é˜ˆå€¼</div>
      <div class="summary-value">
        RM {{ "{:,.2f}".format(threshold|float) }}
      </div>
    </div>
  </section>

  <!-- é£é™©å·ç è¡¨æ ¼ -->
  <section class="table-card">
    <h2 class="table-title">é«˜é¢„è®¡èµ”ä»˜å·ç åˆ—è¡¨</h2>

    {% if alerts and alerts|length > 0 %}
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>å¼€å¥–æ—¥</th>
              <th>å¸‚åœº</th>
              <th>å·ç ç»„åˆ</th>
              <th style="text-align:right;">å¤´å¥– (RM)</th>
              <th style="text-align:right;">äºŒå¥– (RM)</th>
              <th style="text-align:right;">ä¸‰å¥– (RM)</th>
              <th style="text-align:center;">ä¸‹æ³¨ç¬”æ•°</th>
              <th style="text-align:center;">ä»£ç†æ•°</th>
              <th style="text-align:center;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="alerts-tbody">
            {% for row in alerts %}
            <tr class="alert-row"
                data-date="{{ row.date_ddmm }}"
                data-market="{{ row.market }}"
                data-number="{{ row.number }}"
                data-first="{{ '%.2f'|format(row.expected_1st) }}"
                data-second="{{ '%.2f'|format(row.expected_2nd) }}"
                data-third="{{ '%.2f'|format(row.expected_3rd) }}"
                data-bets="{{ row.bet_count }}"
                data-agents="{{ row.agent_count }}">
              <td>
                <span class="pill pill-small">{{ row.date_ddmm }}</span>
              </td>
              <td>
                <span class="pill pill-market">{{ row.market }}</span>
              </td>
              <td>
                <span class="pill pill-number">{{ row.number }}</span>
              </td>
              <td class="amount">
                <span class="amount-strong">
                  {{ "{:,.2f}".format(row.expected_1st) }}
                </span>
              </td>
              <td class="amount">
                {{ "{:,.2f}".format(row.expected_2nd) }}
              </td>
              <td class="amount">
                {{ "{:,.2f}".format(row.expected_3rd) }}
              </td>
              <td style="text-align:center;">
                <span class="pill">{{ row.bet_count }}</span>
              </td>
              <td style="text-align:center;">
                <span class="pill">{{ row.agent_count }}</span>
              </td>
              <td style="text-align:center;">
                <button type="button" class="btn btn-primary btn-sm confirm-btn">
                  ç¡®è®¤
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">âœ…</div>
        <div>å½“å‰æ¡ä»¶ä¸‹ï¼Œæ²¡æœ‰è¶…è¿‡æé†’é˜ˆå€¼çš„å·ç ã€‚</div>
      </div>
    {% endif %}
  </section>

  <!-- å·²ç¡®è®¤åŒºåŸŸ -->
  <section class="table-card">
    <h2 class="table-title">å·²ç¡®è®¤å·ç </h2>
    <div id="confirmed-empty" class="empty-state">
      æš‚æ— å·²ç¡®è®¤è®°å½•ã€‚
    </div>
    <div class="table-wrapper" id="confirmed-table-wrapper" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>å¼€å¥–æ—¥</th>
            <th>å¸‚åœº</th>
            <th>å·ç ç»„åˆ</th>
            <th style="text-align:right;">å¤´å¥– (RM)</th>
            <th style="text-align:right;">äºŒå¥– (RM)</th>
            <th style="text-align:right;">ä¸‰å¥– (RM)</th>
            <th style="text-align:center;">ä¸‹æ³¨ç¬”æ•°</th>
            <th style="text-align:center;">ä»£ç†æ•°</th>
          </tr>
        </thead>
        <tbody id="confirmed-tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const confirmed = [];

  const alertsBody = document.getElementById('alerts-tbody');
  const confirmedBody = document.getElementById('confirmed-tbody');
  const confirmedEmpty = document.getElementById('confirmed-empty');
  const confirmedWrapper = document.getElementById('confirmed-table-wrapper');

  function renderConfirmed() {
    if (!confirmedBody) return;
    confirmedBody.innerHTML = '';

    if (!confirmed.length) {
      confirmedWrapper.style.display = 'none';
      confirmedEmpty.style.display = 'block';
      return;
    }

    confirmedWrapper.style.display = 'block';
    confirmedEmpty.style.display = 'none';

    confirmed.forEach(function (r) {
      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td><span class="pill pill-small">' + r.date + '</span></td>' +
        '<td><span class="pill pill-market">' + r.market + '</span></td>' +
        '<td><span class="pill pill-number">' + r.number + '</span></td>' +
        '<td class="amount"><span class="amount-strong">' + r.first + '</span></td>' +
        '<td class="amount">' + r.second + '</td>' +
        '<td class="amount">' + r.third + '</td>' +
        '<td style="text-align:center;"><span class="pill">' + r.bets + '</span></td>' +
        '<td style="text-align:center;"><span class="pill">' + r.agents + '</span></td>';
      confirmedBody.appendChild(tr);
    });
  }

  if (alertsBody) {
    alertsBody.addEventListener('click', function (e) {
      const btn = e.target.closest('.confirm-btn');
      if (!btn) return;

      const tr = btn.closest('.alert-row');
      if (!tr) return;

      const record = {
        date: tr.dataset.date || '',
        market: tr.dataset.market || '',
        number: tr.dataset.number || '',
        first: tr.dataset.first || '0.00',
        second: tr.dataset.second || '0.00',
        third: tr.dataset.third || '0.00',
        bets: tr.dataset.bets || '0',
        agents: tr.dataset.agents || '0'
      };

      // é˜²æ­¢é‡å¤æ·»åŠ ï¼šç”¨ æ—¥æœŸ+å¸‚åœº+å·ç  åš key
      const key = record.date + '|' + record.market + '|' + record.number;
      const exists = confirmed.some(function (r) {
        return (r.date + '|' + r.market + '|' + r.number) === key;
      });
      if (!exists) {
        confirmed.push(record);
        renderConfirmed();
      }

      // æŒ‰é’®çŠ¶æ€æ”¹æˆå·²ç¡®è®¤
      btn.textContent = 'å·²ç¡®è®¤';
      btn.disabled = true;
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-ghost');
    });
  }

  // åˆå§‹æ¸²æŸ“ï¼ˆä¸€èˆ¬æ˜¯ç©ºï¼‰
  renderConfirmed();
});
</script>
{% endblock %}
