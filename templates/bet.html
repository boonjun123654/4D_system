{% extends "layout.html" %}
{% block content %}
<h2>下注页面</h2>
<form method="post">
    <table border="1" cellpadding="5">
        <thead>
            <tr>
                <th rowspan="2">#</th>
                <th rowspan="2">下注号码</th>
                <th rowspan="2">大</th>
                <th rowspan="2">小</th>
                <th rowspan="2">千字A</th>
                <th rowspan="2">千字</th>
                <th colspan="7">下注日期</th>
                <th colspan="9">市场</th>
                <th rowspan="2">种类</th>
                <th rowspan="2">总额</th>
            </tr>
            <tr>
                {% for d in range(7) %}
                    <th style="width:40px;">
                        <input type="checkbox" id="select_date_{{ d }}" onclick="toggleColumn('date', {{ d }})"><br>
                        {{ (date_today + timedelta(days=d)).strftime("%-d/%-m") }}
                    </th>
                {% endfor %}
                {% for m in ['M','P','T','S','B','K','W','H','E'] %}
                    {% set bg = {
                        'M': '#ffff00', 'P': '#0000ff', 'T': '#cc0000',
                        'S': '#4c8ed1', 'B': '#e51d20', 'K': '#008835',
                        'W': '#00540e', 'H': '#fed606', 'E': '#ffa500'
                    }[m] %}
                    <th style="background-color:{{ bg }};">
                        <input type="checkbox" id="select_market_{{ m }}" onclick="toggleColumn('market', '{{ m }}')"><br>{{ m }}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for i in range(1, 13) %}
            <tr>
                <td>{{ i }}</td>
                <td>
                    <input type="text" name="number{{ i }}" maxlength="4" inputmode="numeric"
                           pattern="[0-9]{4}" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                           style="width: 80px;">
                </td>
                <td><input type="text" name="big{{ i }}" maxlength="2" inputmode="numeric"
                           pattern="[0-9]{1,2}" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                           style="width: 40px;"></td>
                <td><input type="text" name="small{{ i }}" maxlength="2" inputmode="numeric"
                           pattern="[0-9]{1,2}" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                           style="width: 40px;"></td>
                <td><input type="text" name="k1{{ i }}" maxlength="2" inputmode="numeric"
                           pattern="[0-9]{1,2}" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                           style="width: 40px;"></td>
                <td><input type="text" name="k{{ i }}" maxlength="2" inputmode="numeric"
                           pattern="[0-9]{1,2}" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                           style="width: 40px;"></td>

                {% for d in range(7) %}
                    <td><input type="checkbox" name="date{{ i }}_{{ d }}" class="date_col_{{ d }}" style="width:18px;height:18px;"></td>
                {% endfor %}

                {% for m in ['M','P','T','S','B','K','W','H','E'] %}
                    {% set bg = {
                        'M': '#ffff00', 'P': '#0000ff', 'T': '#cc0000',
                        'S': '#4c8ed1', 'B': '#e51d20', 'K': '#008835',
                        'W': '#00540e', 'H': '#fed606', 'E': '#ffa500'
                    }[m] %}
                    <td style="background-color:{{ bg }};">
                        <input type="checkbox" name="market{{ i }}_{{ m }}" class="market_col_{{ m }}" style="width:18px;height:18px;">
                    </td>
                {% endfor %}

                <td>
                    <select name="type{{ i }}">
                        <option>正字</option>
                        <option>IBox</option>
                        <option>Box</option>
                    </select>
                </td>
                <td>0.00</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</form>

<!-- ✅ JavaScript 脚本（放在页面底部） -->
<script>
function toggleColumn(type, key) {
    let checkboxes;
    if (type === 'date') {
        checkboxes = document.querySelectorAll('.date_col_' + key);
        const state = document.getElementById('select_date_' + key).checked;
        checkboxes.forEach(cb => cb.checked = state);
    }
    if (type === 'market') {
        checkboxes = document.querySelectorAll('.market_col_' + key);
        const state = document.getElementById('select_market_' + key).checked;
        checkboxes.forEach(cb => cb.checked = state);
    }
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const inputs = Array.from(document.querySelectorAll("input[type='text'], select"));

    // 监听所有输入框
    inputs.forEach((input, idx) => {
        input.addEventListener("keydown", function(e) {
            if (e.key === " ") {
                e.preventDefault(); // 阻止空格滚动页面
                if (idx + 1 < inputs.length) {
                    inputs[idx + 1].focus();
                }
            }

            // 如果是下注号码栏，按 Enter 跳到下一行同一栏
            if (e.key === "Enter" && this.name.startsWith("number")) {
                e.preventDefault();
                const match = this.name.match(/^number(\d+)$/);
                if (match) {
                    const nextIndex = parseInt(match[1]) + 1;
                    const nextInput = document.querySelector(`input[name="number${nextIndex}"]`);
                    if (nextInput) {
                        nextInput.focus();
                    }
                }
            }
        });
    });
});
</script>

{% if results %}
<h3>下注结果</h3>
<table border="1" cellpadding="5">
    <thead>
        <tr>
            <th>#</th>
            <th>号码</th>
            <th>类型</th>
            <th>市场</th>
            <th>种类</th>
            <th>下注金额</th>
            <th>组合下注总额</th>
            <th>单注赔率</th>
        </tr>
    </thead>
    <tbody>
        {% for r in results %}
        <tr>
            <td>{{ r.row }}</td>
            <td>{{ r.number }}</td>
            <td>{{ r.type }}</td>
            <td>{{ r.market }}</td>
            <td>{{ r.bet_type }}</td>
            <td>{{ r.amount }}</td>
            <td>{{ r.total }}</td>
            <td>{{ r.payout }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% endblock %}
