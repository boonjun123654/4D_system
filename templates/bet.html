{% extends "layout.html" %}
{% block content %}
<h2>ä¸‹æ³¨é¡µé¢</h2>

<form method="post" onsubmit="return handleBet();">
    {% if session.get('role') == 'admin' %}
    <div style="margin: 20px 0; display: flex; align-items: center; gap: 10px;">
        <label for="agent_id" style="font-weight: bold; font-size: 16px;">é€‰æ‹©ä»£ç†ç”¨æˆ·ï¼š</label>
        <select id="agent_id" name="agent_id" required
                style="padding: 6px 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="">-- è¯·é€‰æ‹©ä»£ç† --</option>
            {% for agent in agents %}
                <option value="{{ agent.id }}">{{ agent.username }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <table border="1" cellpadding="5">
        <thead>
            <tr>
                <th rowspan="2">#</th>
                <th rowspan="2">ä¸‹æ³¨å·ç </th>

                <!-- B/S/A/C/A1 è¡¨å¤´ä¸‹æ€»æ§å°æ ¼ -->
                <th rowspan="2" style="text-align:center;width:70px">
                  B<br>
                  <input type="checkbox" id="fillB"
                         onclick="copyAmountDown('B', this.checked)"
                         style="width:16px;height:16px;">
                </th>
                <th rowspan="2" style="text-align:center;width:70px">
                  S<br>
                  <input type="checkbox" id="fillS"
                         onclick="copyAmountDown('S', this.checked)"
                         style="width:16px;height:16px;">
                </th>
                <th rowspan="2" style="text-align:center;width:70px">
                  A<br>
                  <input type="checkbox" id="fillA"
                         onclick="copyAmountDown('A', this.checked)"
                         style="width:16px;height:16px;">
                </th>
                <th rowspan="2" style="text-align:center;width:70px">
                  C<br>
                  <input type="checkbox" id="fillC"
                         onclick="copyAmountDown('C', this.checked)"
                         style="width:16px;height:16px;">
                </th>
                <th rowspan="2" style="text-align:center;width:70px">
                  A1<br>
                  <input type="checkbox" id="fillA1"
                         onclick="copyAmountDown('A1', this.checked)"
                         style="width:16px;height:16px;">
                </th>

                <th colspan="7">ä¸‹æ³¨æ—¥æœŸ</th>
                <th colspan="9">å¸‚åœº</th>
                <th rowspan="2">ç§ç±»</th>
                <th rowspan="2">æ€»é¢</th>
                <th rowspan="2">ğŸ’°ä¸­å¥–é‡‘é¢</th>
            </tr>
            <tr>
                {% for d in range(7) %}
                    <th style="width:40px;">
                        <input type="checkbox" id="select_date_{{ d }}" onclick="toggleColumn('date', {{ d }})"><br>
                        {{ (date_today + timedelta(days=d)).strftime("%-d/%-m") }}
                    </th>
                {% endfor %}
                {% for m in ['M','P','T','S','B','K','W','H','E'] %}
                    {% set bg = {
                        'M': '#ffff00', 'P': '#0000ff', 'T': '#cc0000',
                        'S': '#4c8ed1', 'B': '#e51d20', 'K': '#008835',
                        'W': '#00540e', 'H': '#fed606', 'E': '#ffa500'
                    }[m] %}
                    <th style="background-color:{{ bg }};">
                        <input type="checkbox" id="select_market_{{ m }}" onclick="toggleColumn('market', '{{ m }}')"><br>{{ m }}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for i in range(1, 13) %}
            <tr>
                <td>{{ i }}</td>
                <td>
                    <input type="text" name="number{{ i }}" maxlength="4" inputmode="numeric"
                           pattern="[0-9]{4}" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                           style="width: 80px;">
                </td>
                <td><input type="text" name="B{{ i }}" inputmode="decimal"
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '')"
                           style="width: 50px;"></td>
                <td><input type="text" name="S{{ i }}" inputmode="decimal"
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '')"
                           style="width: 50px;"></td>
                <td><input type="text" name="A{{ i }}" inputmode="decimal"
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '')"
                           style="width: 50px;"></td>
                <td><input type="text" name="C{{ i }}" inputmode="decimal"
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '')"
                           style="width: 50px;"></td>
                <td><input type="text" name="A1{{ i }}" inputmode="decimal"
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '')"
                           style="width: 50px;"></td>

                {% for d in range(7) %}
                    <td><input type="checkbox" name="date{{ i }}_{{ d }}" class="date_col_{{ d }}" style="width:18px;height:18px;"></td>
                {% endfor %}

                {% for m in ['M','P','T','S','B','K','W','H','E'] %}
                    {% set bg = {
                        'M': '#ffff00', 'P': '#0000ff', 'T': '#cc0000',
                        'S': '#4c8ed1', 'B': '#e51d20', 'K': '#008835',
                        'W': '#00540e', 'H': '#fed606', 'E': '#ffa500'
                    }[m] %}
                    <td style="background-color:{{ bg }};">
                        <input type="checkbox" name="market{{ i }}_{{ m }}" class="market_col_{{ m }}" style="width:18px;height:18px;">
                    </td>
                {% endfor %}

                <td>
                    <select name="type{{ i }}">
                        <option>æ­£å­—</option>
                        <option>IBox</option>
                        <option>Box</option>
                    </select>
                </td>
                <td><span class="row-total">0.00</span></td>
                <td>
                    <span class="win-amount">0.00</span>
                    <input type="hidden" name="win_amount{{ i }}" value="0">
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="22" style="text-align:right; font-weight:bold;">
                    æ€»ä¸‹æ³¨é‡‘é¢ï¼šRM <span id="grand-total">0.00</span>
                </td>
            </tr>
        </tfoot>
    </table>

    <div style="margin-top: 10px;">
        <button type="submit" style="font-size: 18px; padding: 8px 20px;">æäº¤</button>
        <button type="reset" style="font-size: 18px; padding: 8px 20px;">æ¸…é™¤</button>
    </div>
</form>

<!-- JS è„šæœ¬ -->
<script>
const odds = {
    // M / P / T / S / B / K / Wï¼šA1 = 6800
    "M": {"B": {"1st": 2750}, "S": {"1st": 3850}, "A": {"1st": 726}, "C": {"1st": 242}, "A1": {"1st": 6800}},
    "P": {"B": {"1st": 2750}, "S": {"1st": 3850}, "A": {"1st": 726}, "C": {"1st": 242}, "A1": {"1st": 6800}},
    "T": {"B": {"1st": 2750}, "S": {"1st": 3850}, "A": {"1st": 726}, "C": {"1st": 242}, "A1": {"1st": 6800}},
    "S": {"B": {"1st": 2750}, "S": {"1st": 3850}, "A": {"1st": 726}, "C": {"1st": 242}, "A1": {"1st": 6800}},
    "B": {"B": {"1st": 2750}, "S": {"1st": 3850}, "A": {"1st": 726}, "C": {"1st": 242}, "A1": {"1st": 6800}},
    "K": {"B": {"1st": 2750}, "S": {"1st": 3850}, "A": {"1st": 726}, "C": {"1st": 242}, "A1": {"1st": 6800}},
    "W": {"B": {"1st": 2750}, "S": {"1st": 3850}, "A": {"1st": 726}, "C": {"1st": 242}, "A1": {"1st": 6800}},
    // H / Eï¼šA1 = 7140
    "H": {"B": {"1st": 3045}, "S": {"1st": 4095}, "A": {"1st": 740.25}, "C": {"1st": 246.75}, "A1": {"1st": 7140}},
    "E": {"B": {"1st": 3045}, "S": {"1st": 4095}, "A": {"1st": 740.25}, "C": {"1st": 246.75}, "A1": {"1st": 7140}}
};

// å‹¾é€‰ï¼šæŠŠç¬¬1è¡Œçš„è¯¥åˆ—é‡‘é¢å¤åˆ¶åˆ°ç¬¬2~12è¡Œï¼›å–æ¶ˆï¼šæ¸…ç©ºç¬¬2~12è¡Œè¯¥åˆ—é‡‘é¢
function copyAmountDown(col, checked) {
  const first = document.querySelector(`input[name="${col}1"]`);
  const firstVal = first ? first.value : '';
  for (let i = 2; i <= 12; i++) {
    const el = document.querySelector(`input[name="${col}${i}"]`);
    if (!el) continue;
    el.value = checked ? firstVal : '';
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
  }
  if (typeof updateTotals === 'function') { try { updateTotals(); } catch(_) {} }
}

function getHighestWin(markets, B, S, A, C, A1, dateCount, type, number) {
    let max = 0;
    const comboFactor = (type === 'IBox') ? getCombinationCount(number) : 1;
    for (const m of ['H','E','M','P','T','S','B','K','W']) {
        if (!markets.includes(m)) continue;
        const o = odds[m];
        const payoutPerDraw =
            B  * (o.B?.['1st']  || 0) +
            S  * (o.S?.['1st']  || 0) +
            A  * (o.A?.['1st']  || 0) +
            C  * (o.C?.['1st']  || 0) +
            A1 * (o.A1?.['1st'] || 0);
        const totalPayout = payoutPerDraw / comboFactor;
        if (totalPayout > max) max = totalPayout;
    }
    return max;
}

function updateTotals() {
    let grandTotal = 0;
    for (let i = 1; i <= 12; i++) {
        const number = document.querySelector(`input[name="number${i}"]`)?.value || '';
        const type = document.querySelector(`select[name="type${i}"]`)?.value || 'æ­£å­—';

        const B  = parseFloat(document.querySelector(`input[name="B${i}"]`)  ?.value) || 0;
        const S  = parseFloat(document.querySelector(`input[name="S${i}"]`)  ?.value) || 0;
        const A  = parseFloat(document.querySelector(`input[name="A${i}"]`)  ?.value) || 0;
        const C  = parseFloat(document.querySelector(`input[name="C${i}"]`)  ?.value) || 0;
        const A1 = parseFloat(document.querySelector(`input[name="A1${i}"]`) ?.value) || 0;

        let dateCount = 0;
        const markets = [];
        for (let d = 0; d < 7; d++) {
            if (document.querySelector(`input[name="date${i}_${d}"]`)?.checked) dateCount++;
        }
        for (const m of ['M','P','T','S','B','K','W','H','E']) {
            if (document.querySelector(`input[name="market${i}_${m}"]`)?.checked) {
                markets.push(m);
            }
        }

        const comboCount = getCombinationCount(number);
        const factor = (type === 'Box') ? comboCount : 1;
        const rowTotal = ((B + S + A + C + A1) * factor) * dateCount * markets.length;
        document.querySelectorAll(".row-total")[i - 1].innerText = rowTotal.toFixed(2);
        grandTotal += rowTotal;

        const win = getHighestWin(markets, B, S, A, C, A1, dateCount, type, number);
        document.querySelector(`input[name="win_amount${i}"]`).value = win.toFixed(2);
        document.querySelectorAll(".win-amount")[i - 1].innerText = win.toFixed(2);
    }
    document.getElementById("grand-total").innerText = grandTotal.toFixed(2);
}

// æŒ‰â€œæ—¥æœŸ â†’ å¸‚åœºç»„åˆâ€åˆ†ç»„ï¼Œå¹¶åˆå¹¶ç›¸åŒå·ç çš„é‡‘é¢åæ˜¾ç¤º
function handleBet() {
    // â€”â€” æˆªæ­¢æ—¶é—´æ£€æŸ¥ â€”â€” 
    const malaysiaNow = new Date(
        new Date().toLocaleString("en-US", { timeZone: "Asia/Kuala_Lumpur" })
    );
    const cutoff = new Date(malaysiaNow);
    cutoff.setHours(19, 0, 0, 0);

    // è¡¨å¤´ 7 å¤©æ—¥æœŸæ ‡ç­¾ -> dd/mm
    const headerDateToDdmm = (dIndex) => {
        const raw = document.getElementById(`select_date_${dIndex}`)?.parentElement
            .textContent.trim().split('\n').pop().trim();
        if (!raw) return '';
        const [d, m] = raw.split('/').map(n => n.padStart(2,'0'));
        return `${d}/${m}`;
    };

    // æ”¶é›†æœ‰å·ç çš„è¡Œæ‰€é€‰æ—¥æœŸï¼ˆç”¨äºæˆªæ­¢æ£€æŸ¥ï¼‰
    const pickedDatesSet = new Set();
    for (let i = 1; i <= 12; i++) {
        const num = document.querySelector(`input[name="number${i}"]`)?.value.trim();
        if (!num) continue;
        for (let d = 0; d < 7; d++) {
            const cb = document.querySelector(`input[name="date${i}_${d}"]`);
            if (cb?.checked) pickedDatesSet.add(headerDateToDdmm(d));
        }
    }
    const todayStr = `${String(malaysiaNow.getDate()).padStart(2,'0')}/${String(malaysiaNow.getMonth()+1).padStart(2,'0')}`;
    if (pickedDatesSet.has(todayStr) && malaysiaNow >= cutoff) {
        alert("âš ï¸ ä»Šå¤©çš„ä¸‹æ³¨å·²æˆªæ­¢ï¼ˆæ™šä¸Š 7 ç‚¹åæ— æ³•ä¸‹æ³¨ï¼‰");
        return false;
    }

    // ç»Ÿè®¡æ€»é¢ & åˆ†ç»„
    const MARKET_ORDER = ['M','P','T','S','B','K','W','H','E'];
    const fmt = (v) => (Number.isInteger(v) ? String(v) : (Math.round(v*100)/100).toFixed(2).replace(/\.00$/,''));

    let grandTotal = 0;

    const grouped = {};
    const dateOrder = [];

    const ensureDate = (ddmm) => {
        if (!grouped[ddmm]) {
            grouped[ddmm] = { comboOrder: [], combos: {} };
            dateOrder.push(ddmm);
        }
        return grouped[ddmm];
    };
    const ensureCombo = (dateObj, comboKey) => {
        if (!dateObj.combos[comboKey]) {
            dateObj.combos[comboKey] = { order: [], items: {} };
            dateObj.comboOrder.push(comboKey);
        }
        return dateObj.combos[comboKey];
    };

    for (let i = 1; i <= 12; i++) {
        const num  = document.querySelector(`input[name="number${i}"]`)?.value.trim();
        if (!num) continue;

        const type = document.querySelector(`select[name="type${i}"]`)?.value || 'æ­£å­—';
        const B  = parseFloat(document.querySelector(`input[name="B${i}"]`)  ?.value) || 0;
        const S  = parseFloat(document.querySelector(`input[name="S${i}"]`)  ?.value) || 0;
        const A  = parseFloat(document.querySelector(`input[name="A${i}"]`)  ?.value) || 0;
        const C  = parseFloat(document.querySelector(`input[name="C${i}"]`)  ?.value) || 0;
        const A1 = parseFloat(document.querySelector(`input[name="A1${i}"]`) ?.value) || 0;

        const rowTotal = parseFloat(document.querySelectorAll(".row-total")[i - 1].innerText) || 0;
        grandTotal += rowTotal;

        const rowDates = [];
        for (let d = 0; d < 7; d++) {
            const cb = document.querySelector(`input[name="date${i}_${d}"]`);
            if (cb?.checked) rowDates.push(headerDateToDdmm(d));
        }
        const rowMarkets = [];
        for (const m of MARKET_ORDER) {
            const cb = document.querySelector(`input[name="market${i}_${m}"]`);
            if (cb?.checked) rowMarkets.push(m);
        }
        if (!rowDates.length || !rowMarkets.length) continue;

        const comboKey = rowMarkets.join('');

        for (const ddmm of rowDates) {
            const dObj = ensureDate(ddmm);
            const cObj = ensureCombo(dObj, comboKey);

            const itemKey = `${num}|${type}`;
            if (!cObj.items[itemKey]) {
                cObj.items[itemKey] = { num, type, B:0, S:0, A:0, C:0, A1:0 };
                cObj.order.push(itemKey);
            }
            cObj.items[itemKey].B  += B;
            cObj.items[itemKey].S  += S;
            cObj.items[itemKey].A  += A;
            cObj.items[itemKey].C  += C;
            cObj.items[itemKey].A1 += A1;
        }
    }

    // â€”â€” ä¸å†åš MAX_WIN æ£€æŸ¥ï¼ˆåˆ é™¤ RM10000 å¼¹æ¡†é€»è¾‘ï¼‰â€”â€”  

    // äºŒæ¬¡ç¡®è®¤
    const confirmMsg = `ä¸‹æ³¨æ€»é‡‘é¢ = RM ${grandTotal.toFixed(2)}\nç¡®è®¤ä¸‹æ³¨ï¼Ÿ`;
    if (!confirm(confirmMsg)) return false;

    // ç»„è£…å¼¹çª—æ–‡æœ¬
    const formattedTotal = Number.isInteger(grandTotal) ? grandTotal : grandTotal.toFixed(2);
    const sections = [];
    for (const ddmm of dateOrder) {
        const dObj = grouped[ddmm];
        if (!dObj) continue;

        sections.push(ddmm);
        for (const comboKey of dObj.comboOrder) {
            const cObj = dObj.combos[comboKey];
            if (!cObj || !cObj.order.length) continue;

            sections.push(`*${comboKey}`);
            for (const itemKey of cObj.order) {
                const it = cObj.items[itemKey];
                const parts = [];
                if (it.B)  parts.push(`${fmt(it.B)}B`);
                if (it.S)  parts.push(`${fmt(it.S)}S`);
                if (it.A)  parts.push(`${fmt(it.A)}A`);
                if (it.C)  parts.push(`${fmt(it.C)}C`);
                if (it.A1) parts.push(`${fmt(it.A1)}A1`);
                const typeSuffix = (it.type && it.type !== 'æ­£å­—') ? ` (${it.type})` : '';
                sections.push(`${it.num}=${parts.join(' ')}${typeSuffix}`);
            }
        }
        sections.push('');
    }
    sections.push(`GT=${formattedTotal}`);
    const finalText = sections.join('\n').replace(/\n{3,}/g, '\n\n');

    setTimeout(() => {
        localStorage.setItem("bet_popup", finalText);
        showBetPopup(finalText);
    }, 100);

    return true;
}

function confirmResult() {
    const modal = document.getElementById("resultModal");
    if (modal) modal.remove();
}

function copyResult() {
    const text = document.getElementById("resultText")?.innerText || "";
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
        alert("âœ… å·²å¤åˆ¶ä¸‹æ³¨ä¿¡æ¯");
    }).catch(err => {
        alert("âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰å–æ–‡å­—");
        console.error("Clipboard error:", err);
    });
}

function toggleColumn(type, key) {
    let checkboxes;
    if (type === 'date') {
        checkboxes = document.querySelectorAll('.date_col_' + key);
        const state = document.getElementById('select_date_' + key).checked;
        checkboxes.forEach(cb => cb.checked = state);
    }
    if (type === 'market') {
        checkboxes = document.querySelectorAll('.market_col_' + key);
        const state = document.getElementById('select_market_' + key).checked;
        checkboxes.forEach(cb => cb.checked = state);
    }
}

function getCombinationCount(number) {
    const digits = number.padStart(4, '0').split('');
    const counts = {};
    digits.forEach(d => counts[d] = (counts[d] || 0) + 1);
    const values = Object.values(counts).sort((a, b) => b - a).join(',');
    switch (values) {
        case '4': return 1;
        case '3,1': return 4;
        case '2,2': return 6;
        case '2,1,1': return 12;
        case '1,1,1,1': return 24;
        default: return 0;
    }
}

function showBetPopup(text) {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div id="resultModal" style="
            position:fixed;
            top:20px;left: 10px;
            background:#ffffff;
            border: 1px solid black;
            border-radius:12px;
            box-shadow:0 4px 10px rgba(0,0,0,0.15);
            padding:16px;
            width:90%;
            max-width:340px;
            z-index:9999;
            font-size:15px;
            font-family:system-ui, sans-serif;
        ">
            <div id="resultText" style="
                white-space:pre-wrap;
                word-break:break-word;
                margin-bottom:16px;
            ">${text}</div>
            <div style="display:flex;justify-content:space-between;">
                <button onclick="copyResult()" style="
                    flex:1;
                    margin-right:10px;
                    padding:8px;
                    background:#007bff;
                    color:white;
                    border:none;
                    border-radius:6px;
                ">å¤åˆ¶</button>
                <button onclick="confirmResult()" style="
                    flex:1;
                    padding:8px;
                    background:#28a745;
                    color:white;
                    border:none;
                    border-radius:6px;
                ">ç¡®è®¤</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
}

// é™åˆ¶ä¸åˆæ³•æ—¥æœŸå’Œå¸‚åœºé€‰æ‹©é€»è¾‘
function applyDateMarketRules() {
    const malaysiaNow = new Date(
        new Date().toLocaleString("en-US", { timeZone: "Asia/Kuala_Lumpur" })
    );
    const baseDate = new Date(malaysiaNow);
    baseDate.setHours(0, 0, 0, 0);

    const weekdays = [];
    for (let d = 0; d < 7; d++) {
        const day = new Date(baseDate);
        day.setDate(day.getDate() + d);
        weekdays.push(day.getDay()); // 0=Sunday, ..., 6=Saturday
    }

    const restrictedMarkets = ['M','P','T','S','B','K','W'];

    let selectedInvalidDate = false;
    for (let d = 0; d < 7; d++) {
        const wd = weekdays[d];
        const checkbox = document.getElementById(`select_date_${d}`);
        if (checkbox?.checked && ![0, 3, 6].includes(wd)) {
            selectedInvalidDate = true;
            break;
        }
    }

    let selectedRestrictedMarket = false;
    for (const m of restrictedMarkets) {
        const checkbox = document.getElementById(`select_market_${m}`);
        if (checkbox?.checked) {
            selectedRestrictedMarket = true;
            break;
        }
    }

    for (let d = 0; d < 7; d++) {
        const wd = weekdays[d];
        const isValidDate = [0, 3, 6].includes(wd);
        const globalCheckbox = document.getElementById(`select_date_${d}`);

        const shouldDisable = selectedRestrictedMarket && !isValidDate;
        if (globalCheckbox) {
            globalCheckbox.disabled = shouldDisable;
            if (shouldDisable) globalCheckbox.checked = false;
        }

        for (let i = 1; i <= 12; i++) {
            const cb = document.querySelector(`input[name="date${i}_${d}"]`);
            if (cb) {
                cb.disabled = shouldDisable;
                if (shouldDisable) cb.checked = false;
            }
        }
    }

    for (const m of restrictedMarkets) {
        const marketCheckbox = document.getElementById(`select_market_${m}`);
        if (marketCheckbox) {
            marketCheckbox.disabled = selectedInvalidDate;
            if (selectedInvalidDate) marketCheckbox.checked = false;
        }

        for (let i = 1; i <= 12; i++) {
            const cb = document.querySelector(`input[name="market${i}_${m}"]`);
            if (cb) {
                cb.disabled = selectedInvalidDate;
                if (selectedInvalidDate) cb.checked = false;
            }
        }
    }
}

function setupBetListeners() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function () {
            updateTotals();
            applyDateMarketRules();
        });
    });
}

document.addEventListener("DOMContentLoaded", function () {
    // ç©ºæ ¼/Enter è·³æ ¼
    const inputs = Array.from(document.querySelectorAll("input[type='text'], select"));
    inputs.forEach((input, idx) => {
        input.addEventListener("keydown", function (e) {
            if (e.key === " ") {
                e.preventDefault();
                if (idx + 1 < inputs.length) inputs[idx + 1].focus();
            }
            if (e.key === "Enter" && this.name && this.name.startsWith("number")) {
                e.preventDefault();
                const match = this.name.match(/^number(\d+)$/);
                if (match) {
                    const nextIndex = parseInt(match[1]) + 1;
                    const nextInput = document.querySelector(`input[name="number${nextIndex}"]`);
                    if (nextInput) nextInput.focus();
                }
            }
        });
    });

    // åˆ·æ–°åæ˜¯å¦æ˜¾ç¤ºä¸‹æ³¨è¯¦æƒ…
    const savedPopup = localStorage.getItem("bet_popup");
    if (savedPopup) {
        showBetPopup(savedPopup);
        localStorage.removeItem("bet_popup");
    }

    // è¾“å…¥å˜åŠ¨è‡ªåŠ¨è®¡ç®—
    document.querySelectorAll('input[type="text"], select').forEach(input => {
        input.addEventListener('input', updateTotals);
    });

    // å‹¾é€‰æ¡†å˜åŠ¨ï¼šè®¡ç®—+è§„åˆ™
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function () {
            updateTotals();
            if (
                this.name?.startsWith('date') ||
                this.name?.startsWith('market') ||
                (this.id && this.id.startsWith('select_date_')) ||
                (this.id && this.id.startsWith('select_market_'))
            ) {
                applyDateMarketRules();
            }
        });
    });

    // é™åˆ¶é€»è¾‘ç›‘å¬å™¨
    setupBetListeners();

    // reset åé‡æ–°è®¡ç®—
    document.querySelector('button[type="reset"]').addEventListener('click', function () {
        setTimeout(() => {
            updateTotals();
            applyDateMarketRules();
        }, 100);
    });

    // å½“æ€»æ§å‹¾ç€æ—¶ï¼Œä¿®æ”¹ç¬¬1è¡Œé‡‘é¢è‡ªåŠ¨åŒæ­¥
    ['B','S','A','C','A1'].forEach(col => {
      const master = document.getElementById('fill' + col);
      const first = document.querySelector(`input[name="${col}1"]`);
      if (first && master) {
        first.addEventListener('input', () => {
          if (master.checked) copyAmountDown(col, true);
        });
      }
    });

    updateTotals();
});

// URL å‚æ•°æç¤ºï¼šåªä¿ç•™ cutoffï¼Œä¸å†æç¤º limit
const params = new URLSearchParams(window.location.search);
if (params.get("error") === "cutoff") {
    alert("âš ï¸ ä»Šå¤©çš„ä¸‹æ³¨å·²æˆªæ­¢ï¼ˆæ™šä¸Š 7 ç‚¹åæ— æ³•ä¸‹æ³¨ï¼‰");
    history.replaceState({}, document.title, location.pathname)
}
</script>
{% endblock %}
