{% extends "layout.html" %}
{% block content %}

<h2 style="margin-top: 20px;">ğŸ§¾ æŸ¥å•è®°å½•</h2>

<form method="get" action="/history" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center;">
  <div>
    <label><strong>æ—¥æœŸèŒƒå›´ï¼š</strong></label><br>
    <input type="date" name="start_date" value="{{ start_date }}" style="padding: 6px;">
    <input type="date" name="end_date" value="{{ end_date }}" style="padding: 6px;">
  </div>

  {% if session.role == 'admin' %}
  <div>
    <label><strong>é€‰æ‹©ä»£ç†ï¼š</strong></label><br>
    <select name="agent_id" style="padding: 6px; width: 150px;">
      <option value="">å…¨éƒ¨</option>
      {% for agent in agents %}
        <option value="{{ agent.username }}" {% if request.args.get('agent_id') == agent.username %}selected{% endif %}>{{ agent.username }}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}

  <div>
    <button type="submit" style="padding: 8px 20px; font-size: 15px;">ğŸ” æŸ¥æ‰¾</button>
  </div>
</form>

<hr>

{% if orders_by_date and orders_by_date|length > 0 %}
  {% for date, orders in orders_by_date.items() %}
    <div style="background: #f2f2f2; padding: 10px; margin-top: 20px; font-weight: bold;">ğŸ“… {{ date }}</div>

    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;">
      {% for order in orders %}
        {% set market_order = ['M','P','T','S','B','K','W','H','E'] %}

        {# === å…ˆæ”¶é›†æœ¬è®¢å•åœ¨â€œå½“å‰è¿™ä¸€å¤©â€å‡ºç°è¿‡çš„ã€å¸‚åœºç»„åˆã€‘ï¼ˆæŒ‰é¦–æ¬¡å‡ºç°é¡ºåºï¼‰ === #}
        {% set combos_order = [] %}
        {% for ln in order.lines %}
          {% if date in (ln.dates or []) %}
            {% set combo_list = [] %}
            {% for m in market_order %}
              {% if m in (ln.markets or []) %}{% set _ = combo_list.append(m) %}{% endif %}
            {% endfor %}
            {% set combo = combo_list|join('') %}
            {% if combo and combo not in combos_order %}{% set _ = combos_order.append(combo) %}{% endif %}
          {% endif %}
        {% endfor %}

        {# === å¤åˆ¶æ–‡æœ¬ï¼šæŒ‰â€œæ—¥æœŸ â†’ å¸‚åœºç»„åˆâ€åˆ†æ®µ === #}
        {% set payload_lines = [date] %}
        {% for combo in combos_order %}
          {% set _ = payload_lines.append('*' ~ combo) %}
          {% for ln in order.lines %}
            {% if date in (ln.dates or []) %}
              {% set cl2 = [] %}
              {% for m in market_order %}
                {% if m in (ln.markets or []) %}{% set _ = cl2.append(m) %}{% endif %}
              {% endfor %}
              {% set combo2 = cl2|join('') %}
              {% if combo2 == combo %}
                {% set parts = [] %}
                {% if ln.b and ln.b|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.b)).replace(".0","") ~ "B") %}{% endif %}
                {% if ln.s and ln.s|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.s)).replace(".0","") ~ "S") %}{% endif %}
                {% if ln.a and ln.a|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.a)).replace(".0","") ~ "A") %}{% endif %}
                {% if ln.c and ln.c|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.c)).replace(".0","") ~ "C") %}{% endif %}
                {% set line_txt = ln.number ~ '=' ~ (parts|join(' ')) ~ ((' (' ~ ln.type ~ ')') if ln.type != 'æ­£å­—' else '') %}
                {% set _ = payload_lines.append(line_txt) %}
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endfor %}
        {% set copy_payload = (payload_lines|join("\n")) ~ "\nGT=" ~ (("%.0f"|format(order.gt_total)) if (order.gt_total|float).is_integer() else ("%.2f"|format(order.gt_total))) %}

        <div class="order-card" style="width: 360px; border: 1px solid #ddd; padding: 12px; border-radius: 10px;
          {% if order.status == 'delete' %}background-color:#cfc8ca;color:#000;opacity:.85;{% else %}background-color:#fff;{% endif %}
          box-shadow: 2px 2px 5px rgba(0,0,0,0.05); font-family: monospace; display:flex; flex-direction:column; justify-content:space-between;">

          <div style="font-size: 14px; background:#f8f8f8; padding:6px 8px; border-radius:6px; margin-bottom:8px;">
            ğŸ‘¤ <strong>ä»£ç†ï¼š</strong>{{ order.agent_id }}
          </div>

          {# === å¡ç‰‡æ˜¾ç¤ºï¼šæŒ‰â€œæ—¥æœŸ â†’ å¸‚åœºç»„åˆâ€åˆ†æ®µ === #}
          <div style="flex-grow:1; margin-bottom:10px; font-size:14px; line-height:1.6;">
            <div>{{ date }}</div>
            {% for combo in combos_order %}
              <div>*{{ combo }}</div>
              {% for ln in order.lines %}
                {% if date in (ln.dates or []) %}
                  {% set cl2 = [] %}
                  {% for m in market_order %}
                    {% if m in (ln.markets or []) %}{% set _ = cl2.append(m) %}{% endif %}
                  {% endfor %}
                  {% if (cl2|join('')) == combo %}
                    {% set parts = [] %}
                    {% if ln.b and ln.b|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.b)).replace(".0","") ~ "B") %}{% endif %}
                    {% if ln.s and ln.s|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.s)).replace(".0","") ~ "S") %}{% endif %}
                    {% if ln.a and ln.a|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.a)).replace(".0","") ~ "A") %}{% endif %}
                    {% if ln.c and ln.c|float > 0 %}{% set _ = parts.append(("%.1f"|format(ln.c)).replace(".0","") ~ "C") %}{% endif %}
                    <div>{{ ln.number }}={{ parts|join(' ') }}{% if ln.type != 'æ­£å­—' %} ({{ ln.type }}){% endif %}</div>
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            <div>GT={{ (("%.0f"|format(order.gt_total)) if (order.gt_total|float).is_integer() else ("%.2f"|format(order.gt_total))) }}</div>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" class="copy-btn"
                    data-copy="{{ copy_payload | e }}"
                    style="flex:1; padding: 6px 10px; background:#f0f0f0; border:1px solid #ddd; border-radius:6px; cursor:pointer;">
              å¤åˆ¶
            </button>

            {% if order.status == 'locked' %}
              <button type="button" disabled style="flex:1; padding:6px 10px; background:#ccc; color:#666; border:none; border-radius:6px;">
                å·²é”æ³¨
              </button>
            {% elif order.status == 'delete' %}
              <span style="flex:1; text-align:center; padding:6px 10px; background:#0a0a0a; color:#fff; border-radius:6px;">
                ğŸ—‘ï¸ å·²åˆ é™¤
              </span>
            {% else %}
              <form method="post"
                    style="flex:1"
                    action="{{ url_for('delete_order', order_code=order.order_code) }}?start_date={{ start_date }}&end_date={{ end_date }}{% if selected_agent %}&agent_id={{ selected_agent }}{% endif %}"
                    onsubmit="return confirm('ç¡®è®¤åˆ é™¤æ­¤è®¢å•ï¼Ÿ');">
                <button type="submit" style="width:100%; padding:6px 10px; background-color:#dc3545; color:white; border:none; border-radius:6px;">
                  åˆ é™¤
                </button>
              </form>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
{% endif %}

{# ========== å…¼å®¹æ—§æ•°æ®ï¼šæ— è®¢å•å·çš„å†å²è¡Œï¼ˆlegacy_groupedï¼‰ä¿æŒä¸å˜ ========== #}
{% if legacy_grouped and legacy_grouped|length > 0 %}
  <div style="margin: 30px 0 10px; font-weight:bold;">ğŸ“œ å†å²æ—§å•ï¼ˆæ— è®¢å•å·ï¼‰</div>
  {% for date, items in legacy_grouped.items() %}
    <div style="background:#f2f2f2; padding:10px; margin-top:12px; font-weight:bold;">ğŸ“… {{ date }}</div>
    <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:30px;">
      {% for bet in items %}
        <div style="width:260px; border:1px solid #ddd; padding:10px; border-radius:8px;
             {% if bet.status == 'delete' %}background:#cfc8ca;color:#000;opacity:.6;{% else %}background:#fff;{% endif %}
             box-shadow:2px 2px 5px rgba(0,0,0,0.05); font-family:monospace; display:flex; flex-direction:column; justify-content:space-between;">
          <div style="font-size:14px; background:#f8f8f8; padding:4px 8px; border-radius:4px; margin-bottom:6px;">
            ğŸ‘¤ <strong>ä»£ç†ï¼š</strong>{{ bet.agent_id }}
          </div>
          <div style="flex-grow:1; margin-bottom:40px; font-size:14px;">
            {% for d in bet.dates %}
              <div><strong>{{ d }}</strong></div>
              <div>{{ bet.markets | join('') }}</div>
            {% endfor %}
            <div>
              {{ bet.number }} =
              {% if bet.b %}{{ "%.1f"|format(bet.b)|replace(".0","") }}B {% endif %}
              {% if bet.s %}{{ "%.1f"|format(bet.s)|replace(".0","") }}S {% endif %}
              {% if bet.a %}{{ "%.1f"|format(bet.a)|replace(".0","") }}A {% endif %}
              {% if bet.c %}{{ "%.1f"|format(bet.c)|replace(".0","") }}C {% endif %}
              {% if bet.type != 'æ­£å­—' %}({{ bet.type }}){% endif %}
            </div>
            <div>GT = {{ "%.2f"|format(bet.total)|replace(".00","") }}</div>
            {% if bet.win_amount %}<div style="color:#28a745;">WIN = {{ "%.2f"|format(bet.win_amount)|replace(".00","") }}</div>{% endif %}
          </div>
          <div style="display:flex; gap:8px;">
            <a href="/bet?ref={{ bet.id }}" style="flex:1;">
              <button type="button" style="width:100%; padding:6px; background:#007bff; color:#fff; border:none; border-radius:4px;">é‡æ–°ä¸‹æ³¨</button>
            </a>
            {% if bet.status == 'locked' %}
              <button type="button" disabled style="flex:1; padding:6px; background:#ccc; color:#666; border:none; border-radius:4px;">å·²é”æ³¨</button>
            {% elif bet.status == 'delete' %}
              <div style="flex:1; text-align:center; padding:6px; background:#0a0a0a; color:#fff; border-radius:4px;">ğŸ—‘ï¸ å·²åˆ é™¤</div>
            {% else %}
              <form method="post" style="flex:1"
                    action="{{ url_for('delete_bet', bet_id=bet.id) }}?start_date={{ start_date }}&end_date={{ end_date }}{% if selected_agent %}&agent_id={{ selected_agent }}{% endif %}"
                    onsubmit="return confirm('ç¡®è®¤åˆ é™¤æ­¤ä¸‹æ³¨ï¼Ÿ');">
                <input type="hidden" name="start_date" value="{{ start_date }}">
                <input type="hidden" name="end_date" value="{{ end_date }}">
                {% if selected_agent %}<input type="hidden" name="agent_id" value="{{ selected_agent }}">{% endif %}
                <button type="submit" style="width: 100%; padding: 6px; background:#dc3545; color:white; border:none; border-radius:4px; font-size:15px;">åˆ é™¤ä¸‹æ³¨</button>
              </form>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
{% endif %}

{% if (not orders_by_date or orders_by_date|length == 0) and (not legacy_grouped or legacy_grouped|length == 0) %}
  <p style="color:#cc0000; font-size:16px;">â— æ²¡æœ‰è®°å½•</p>
{% endif %}

<script>
document.addEventListener('click', function(e){
  const btn = e.target.closest('.copy-btn');
  if(!btn) return;
  const text = (btn.getAttribute('data-copy') || '').trim();
  navigator.clipboard.writeText(text).then(()=>{
    alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  }).catch(()=>{
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  });
});

const params = new URLSearchParams(window.location.search);
if (params.get("deleted") === "1") {
  alert("âœ… å·²åˆ é™¤ä¸‹æ³¨è®°å½•");
} else if (params.get("error") === "unauthorized") {
  alert("âŒ æ— æƒé™åˆ é™¤è¯¥ä¸‹æ³¨è®°å½•");
} else if (params.get("error") === "locked") {
  alert("âš ï¸ æ­¤ä¸‹æ³¨è®°å½•å·²é”æ³¨ï¼Œæ— æ³•åˆ é™¤");
}
history.replaceState({}, document.title, location.pathname);
</script>

{% endblock %}
