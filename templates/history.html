{% extends "layout.html" %}
{% block content %}

<h2 style="margin-top: 20px;">ğŸ§¾ æŸ¥å•è®°å½•</h2>

<form method="get" action="/history" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center;">
    <div>
        <label><strong>æ—¥æœŸèŒƒå›´ï¼š</strong></label><br>
        <input type="date" name="start_date" value="{{ start_date }}" style="padding: 6px;">
        <input type="date" name="end_date" value="{{ end_date }}" style="padding: 6px;">
    </div>

    {% if session.role == 'admin' %}
    <div>
        <label><strong>é€‰æ‹©ä»£ç†ï¼š</strong></label><br>
        <select name="agent_id" style="padding: 6px; width: 150px;">
            <option value="">å…¨éƒ¨</option>
            {% for agent in agents %}
                <option value="{{ agent.username }}" {% if request.args.get('agent_id') == agent.username %}selected{% endif %}>
                    {{ agent.username }}
                </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div>
        <button type="submit" style="padding: 8px 20px; font-size: 15px;">ğŸ” æŸ¥æ‰¾</button>
    </div>
</form>

<hr>

{# ========== æ–°ï¼šæŒ‰è®¢å•èšåˆæ˜¾ç¤ºï¼ˆorders_by_dateï¼‰ ========== #}
{% if orders_by_date and orders_by_date|length > 0 %}
  {% for date, orders in orders_by_date.items() %}
    <div style="background: #f2f2f2; padding: 10px; margin-top: 20px; font-weight: bold;">
      ğŸ“… {{ date }}
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;">
      {% for order in orders %}
        <div style="width: 360px; border: 1px solid #ddd; padding: 12px; border-radius: 10px;
            {% if order.status == 'delete' %}
                background-color: #cfc8ca; color: #000000; opacity: 0.7;
            {% else %}
                background-color: #fff;
            {% endif %}
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05); font-family: monospace;
            display: flex; flex-direction: column; justify-content: space-between; position: relative;">

          {# è®¢å•å¤´ #}
          <div style="font-size: 13px; background: #f8f8f8; padding: 6px 8px; border-radius: 6px; margin-bottom: 8px; display: grid; grid-template-columns: 1fr; gap: 4px;">
            <div>ğŸ“¦ <strong>è®¢å•å·ï¼š</strong>{{ order.order_code }}</div>
            <div>ğŸ‘¤ <strong>ä»£ç†ï¼š</strong>{{ order.agent_id }}</div>
            <div>ğŸ—“ï¸ <strong>å¼€å¥–æ—¥æœŸï¼š</strong>{% for d in order.dates %}<span style="margin-right:6px">{{ d }}</span>{% endfor %}</div>
            <div>ğŸ·ï¸ <strong>å¸‚åœºï¼š</strong>
              {% for ch in order.markets %}
                <span style="display:inline-block;border:1px solid #ddd;border-radius:4px;padding:0 6px;margin-right:4px;font-family:system-ui, -apple-system, Segoe UI, Roboto;">*{{ ch }}</span>
              {% endfor %}
            </div>
          </div>

          {# æ˜ç»†è¡Œ #}
          <div style="flex-grow: 1; margin-bottom: 12px; font-size: 14px; line-height: 1.5;">
            {% if order.lines and order.lines|length > 0 %}
              {% for ln in order.lines %}
                <div style="padding: 4px 0; border-bottom: 1px dashed #eee;">
                  {# å·ç  + é‡‘é¢é¡¹ï¼ˆåªæ˜¾ç¤ºé0ï¼‰ #}
                  <div>
                    {{ ln.number }} =
                    {% if ln.b and ln.b|float > 0 %}{{ "%.1f"|format(ln.b)|replace(".0","") }}B {% endif %}
                    {% if ln.s and ln.s|float > 0 %}{{ "%.1f"|format(ln.s)|replace(".0","") }}S {% endif %}
                    {% if ln.a and ln.a|float > 0 %}{{ "%.1f"|format(ln.a)|replace(".0","") }}A {% endif %}
                    {% if ln.c and ln.c|float > 0 %}{{ "%.1f"|format(ln.c)|replace(".0","") }}C {% endif %}
                    {% if ln.type != 'æ­£å­—' %}({{ ln.type }}){% endif %}
                  </div>
                  {# è¡Œå†… GT / WINï¼ˆå¯é€‰å±•ç¤ºï¼‰ #}
                  <div style="font-size:12px;color:#666;">
                    GT={{ "%.2f"|format(ln.total)|replace(".00","") }}
                    {% if ln.win_amount and ln.win_amount|float > 0 %}
                      <span style="color:#28a745; margin-left:8px;">WIN={{ "%.2f"|format(ln.win_amount)|replace(".00","") }}</span>
                    {% endif %}
                    {% if ln.markets %}
                      <span style="margin-left:8px; color:#999;">{{ ln.markets|join('') }}</span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div style="color:#999;">ï¼ˆæ— æ˜ç»†ï¼‰</div>
            {% endif %}
          </div>

          {# æ•´å•åˆè®¡ #}
          <div style="display:flex; justify-content:space-between; align-items:center; font-size:14px; margin-top: 6px;">
            <div>
              <strong>GT</strong> = {{ "%.2f"|format(order.gt_total)|replace(".00","") }}
              {% if order.win_total and order.win_total|float > 0 %}
                <span style="margin-left:10px; color:#28a745;"><strong>WIN</strong> = {{ "%.2f"|format(order.win_total)|replace(".00","") }}</span>
              {% endif %}
            </div>
            <div>
              {% if order.status == 'locked' %}
                <span style="display:inline-block;padding:6px 10px;background:#ccc;color:#666;border-radius:6px;cursor:not-allowed;">å·²é”æ³¨</span>
              {% elif order.status == 'delete' %}
                <span style="display:inline-block;padding:6px 10px;background:#0a0a0a;color:#fff;border-radius:6px;">ğŸ—‘ï¸ å·²åˆ é™¤</span>
              {% else %}
                <a href="/bet?order={{ order.order_code }}">
                  <button type="button" style="padding: 6px 12px; background-color:#007bff; color:white; border:none; border-radius:6px;">é‡æ–°ä¸‹æ³¨æ•´å•</button>
                </a>
                {# å¦‚éœ€â€œæ•´å•åˆ é™¤â€ï¼Œå¾…ä½ å®ç°åå¯å¯ç”¨ï¼š
                <form method="post" action="/delete_order/{{ order.order_code }}" style="display:inline" onsubmit="return confirm('ç¡®è®¤åˆ é™¤æ­¤è®¢å•ï¼Ÿ');">
                  <button type="submit" style="padding:6px 12px; background-color:#dc3545; color:white; border:none; border-radius:6px; margin-left:6px;">åˆ é™¤è®¢å•</button>
                </form>
                #}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
{% endif %}

{# ========== å…¼å®¹æ—§æ•°æ®ï¼šæ— è®¢å•å·çš„å†å²è¡Œï¼ˆlegacy_groupedï¼‰ ========== #}
{% if legacy_grouped and legacy_grouped|length > 0 %}
  <div style="margin: 30px 0 10px; font-weight:bold;">ğŸ“œ å†å²æ—§å•ï¼ˆæ— è®¢å•å·ï¼‰</div>
  {% for date, items in legacy_grouped.items() %}
    <div style="background: #f2f2f2; padding: 10px; margin-top: 12px; font-weight: bold;">
        ğŸ“… {{ date }}
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;">
      {% for bet in items %}
        <div style="width: 260px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;
            {% if bet.status == 'delete' %}
                background-color: #cfc8ca; color: #000000; opacity: 0.6;
            {% else %}
                background-color: #fff;
            {% endif %}
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05); font-family: monospace;
            display: flex; flex-direction: column; justify-content: space-between; position: relative;">

            <div style="font-size: 14px; background: #f8f8f8; padding: 4px 8px; border-radius: 4px; margin-bottom: 6px;">
                ğŸ‘¤ <strong>ä»£ç†ï¼š</strong>{{ bet.agent_id }}
            </div>

            <div style="flex-grow: 1; margin-bottom: 40px; font-size: 14px;">
                {% for d in bet.dates %}
                    <div><strong>{{ d }}</strong></div>
                    <div>{{ bet.markets | join('') }}</div>
                {% endfor %}
                <div>
                    {{ bet.number }} =
                    {% if bet.b %}{{ "%.1f"|format(bet.b)|replace(".0", "") }}B {% endif %}
                    {% if bet.s %}{{ "%.1f"|format(bet.s)|replace(".0", "") }}S {% endif %}
                    {% if bet.a %}{{ "%.1f"|format(bet.a)|replace(".0", "") }}A {% endif %}
                    {% if bet.c %}{{ "%.1f"|format(bet.c)|replace(".0", "") }}C {% endif %}
                    {% if bet.type != 'æ­£å­—' %}({{ bet.type }}){% endif %}
                </div>
                <div>GT = {{ "%.2f"|format(bet.total)|replace(".00", "") }}</div>
                {% if bet.win_amount %}
                    <div style="color: #28a745;">WIN = {{ "%.2f"|format(bet.win_amount)|replace(".00", "") }}</div>
                {% endif %}
            </div>

            <div style="display: flex; gap: 8px;">
                <a href="/bet?ref={{ bet.id }}" style="flex: 1;">
                    <button type="button" style="width: 100%; padding: 6px; background-color:#007bff; color:white; border:none; border-radius:4px;">é‡æ–°ä¸‹æ³¨</button>
                </a>

                {% if bet.status == 'locked' %}
                    <button type="button" disabled style="flex: 1; padding: 6px; background-color:#ccc; color:#666; border:none; border-radius:4px; cursor: not-allowed;">
                        å·²é”æ³¨
                    </button>
                {% elif bet.status == 'delete' %}
                    <div style="flex: 1; text-align: center; padding: 6px; background-color: #0a0a0a; color: #ffffff; border-radius: 4px;">
                        ğŸ—‘ï¸ å·²åˆ é™¤
                    </div>
                {% else %}
                    <form method="post"
                          style="flex: 1"
                          action="/delete_bet/{{ bet.id }}?start_date={{ start_date }}&end_date={{ end_date }}{% if selected_agent %}&agent_id={{ selected_agent }}{% endif %}"
                          onsubmit="return confirm('ç¡®è®¤åˆ é™¤æ­¤ä¸‹æ³¨ï¼Ÿ');">
                        <input type="hidden" name="start_date" value="{{ start_date }}">
                        <input type="hidden" name="end_date" value="{{ end_date }}">
                        {% if selected_agent %}
                            <input type="hidden" name="agent_id" value="{{ selected_agent }}">
                        {% endif %}
                        <button type="submit" style="width: 100%; padding: 6px; background-color:#dc3545; color:white; border:none; border-radius:4px; font-size: 15px;">åˆ é™¤ä¸‹æ³¨</button>
                    </form>
                {% endif %}
            </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
{% endif %}

{% if (not orders_by_date or orders_by_date|length == 0) and (not legacy_grouped or legacy_grouped|length == 0) %}
  <p style="color: #cc0000; font-size: 16px;">â— æ²¡æœ‰è®°å½•</p>
{% endif %}

<script>
const params = new URLSearchParams(window.location.search);
if (params.get("deleted") === "1") {
    alert("âœ… å·²åˆ é™¤ä¸‹æ³¨è®°å½•");
} else if (params.get("error") === "unauthorized") {
    alert("âŒ æ— æƒé™åˆ é™¤è¯¥ä¸‹æ³¨è®°å½•");
} else if (params.get("error") === "locked") {
    alert("âš ï¸ æ­¤ä¸‹æ³¨è®°å½•å·²é”æ³¨ï¼Œæ— æ³•åˆ é™¤");
}
history.replaceState({}, document.title, location.pathname);
</script>
{% endblock %}
