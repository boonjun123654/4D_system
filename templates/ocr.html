{% extends "layout.html" %}
{% block content %}
<h2>OCR 识别当期成绩</h2>

<div style="margin:12px 0; display:flex; gap:10px; align-items:center;">
  <label>开奖日期：</label>
  <input type="date" id="draw_date" required>
  <label>Market：</label>
  <select id="market" required>
    <option value="M">M</option>
    <option value="P">P</option>
    <option value="T">T</option>
    <option value="S">S</option>
    <option value="H">H</option>
    <option value="E">E</option>
    <option value="B">B</option>
    <option value="K">K</option>
    <option value="W">W</option>
  </select>
</div>

<input type="file" id="img" accept="image/*">
<button id="btnOcr" style="margin-left:8px;">开始识别</button>
<span id="status" style="margin-left:10px;color:#666;"></span>

<div id="preview" style="margin-top:16px; display:none;">
  <h3>识别结果预览</h3>
  <div style="display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:center;">
    <div>1st:</div> <input id="first" maxlength="4">
    <div>2nd:</div> <input id="second" maxlength="4">
    <div>3rd:</div> <input id="third" maxlength="4">
    <div>Special(10):</div> <input id="special" placeholder="2006,7652,5588,0653,3611,3357,8643,6444,3588,1762">
    <div>Consolation(10):</div> <input id="consolation" placeholder="7868,2714,5699,2317,9134,6564,9034,7952,2044,6534">
  </div>
  <button id="btnSave" style="margin-top:12px;">保存到数据库</button>
</div>

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const $ = (id) => document.getElementById(id);

// === 1) 全局 worker：只创建一次 ===
let workerReady = (async () => {
  const worker = await Tesseract.createWorker();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  // 只认数字、行块级解析、更像票据的排列
  await worker.setParameters({
    tessedit_char_whitelist: '0123456789',
    tessedit_char_blacklist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
    tessedit_pageseg_mode: '6',               // 6: Assume a single uniform block of text
    classify_bln_numeric_mode: '1',           // 数字模式
    preserve_interword_spaces: '1',
    user_defined_dpi: '300'
  });
  return worker;
})();

// === 2) 预处理：缩放、灰度、二值化、去噪 ===
async function preprocess(file) {
  const bmp = await createImageBitmap(file);
  const maxW = 1400;
  const scale = Math.min(1, maxW / bmp.width);
  const w = Math.round(bmp.width * scale);
  const h = Math.round(bmp.height * scale);

  const cv = document.createElement('canvas');
  cv.width = w; cv.height = h;
  const ctx = cv.getContext('2d', { willReadFrequently: true });
  ctx.drawImage(bmp, 0, 0, w, h);

  // 灰度
  let img = ctx.getImageData(0, 0, w, h);
  let d = img.data;
  for (let i = 0; i < d.length; i += 4) {
    const g = d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114;
    d[i] = d[i+1] = d[i+2] = g;
  }
  // 简单阈值（可调 160~200）
  const TH = 180;
  for (let i = 0; i < d.length; i += 4) {
    const v = d[i] > TH ? 255 : 0;
    d[i] = d[i+1] = d[i+2] = v;
  }
  ctx.putImageData(img, 0, 0);

  // 轻度去噪：膨胀/收缩简化 —— 简版：再画一次轻微模糊
  ctx.filter = 'blur(0.3px)';
  ctx.drawImage(cv, 0, 0);

  return cv;
}

// === 3) （可选）ROI：如果你的截图版式固定，按比例裁剪区域识别，速度更快 ===
function crop(canvas, rect) {
  const { width: W, height: H } = canvas;
  const x = Math.round(rect.x * W), y = Math.round(rect.y * H);
  const w = Math.round(rect.w * W), h = Math.round(rect.h * H);
  const cv = document.createElement('canvas');
  cv.width = w; cv.height = h;
  const ctx = cv.getContext('2d');
  ctx.drawImage(canvas, x, y, w, h, 0, 0, w, h);
  return cv;
}

// 例子：按“比例”定义区域（需要你根据常用截图微调到位）
const ROI = {
  first:       { x: 0.13940256045519203, y: 0.21921921921921922, w: 0.17923186344238975, h: 0.06906906906906907 },
  second:      { x: 0.41963015647226176, y: 0.21921921921921922, w: 0.17923186344238975, h: 0.06906906906906907 },
  third:       { x: 0.69985775248933150, y: 0.21921921921921922, w: 0.17923186344238975, h: 0.06906906906906907 },
  special:     { x: 0.059743954480796585, y: 0.35885885885885890, w: 0.8790896159317212, h: 0.16966966966966968 },
  consolation: { x: 0.059743954480796585, y: 0.58858858858858850, w: 0.8790896159317212, h: 0.16966966966966968 }
};

function only4d(arr){ return arr.map(s => (s||'').replace(/\D/g,'')).filter(s => s.length===4); }
function normList(arr, need=10){ return only4d(arr).slice(0, need).join(','); }

async function recognizeCanvas(cv) {
  const worker = await workerReady;
  const { data:{ text } } = await worker.recognize(cv);
  return text;
}

async function runOcr(file, useRoi=true) {
  const pre = await preprocess(file);

  if (useRoi) {
    // 分区识别（更快更准）
    const [t1, t2, t3, ts, tc] = await Promise.all([
      recognizeCanvas(crop(pre, ROI.first)),
      recognizeCanvas(crop(pre, ROI.second)),
      recognizeCanvas(crop(pre, ROI.third)),
      recognizeCanvas(crop(pre, ROI.specialBlock)),
      recognizeCanvas(crop(pre, ROI.consolBlock)),
    ]);

    const is4 = s => /^\d{4}$/.test(s);
    // 从每个 ROI 中抓最先出现的4位数
    const pick1 = (txt) => (txt.match(/\b\d{4}\b/) || [''])[0];

    const first  = pick1(t1);
    const second = pick1(t2);
    const third  = pick1(t3);

    // 特/慰：提取 10 个
    const specials = (ts.match(/\b\d{4}\b/g) || []).slice(0,10);
    const consols  = (tc.match(/\b\d{4}\b/g) || []).slice(0,10);

    return {
      first, second, third,
      special: normList(specials, 10),
      consolation: normList(consols, 10),
    };
  } else {
    // 整图识别（通用兜底）
    const worker = await workerReady;
    const { data:{ text } } = await worker.recognize(pre);
    return extractByHeuristics(text); // 你的原有解析函数可保留
  }
}

// === 4) 绑定按钮：复用 worker + ROI ===
$('btnOcr').addEventListener('click', async () => {
  const file = $('img').files?.[0];
  if(!file){ alert('请先选择开奖截图'); return; }
  if(!$('draw_date').value){ alert('请选择开奖日期'); return; }

  $('status').textContent = '识别中…（已启用加速）';
  const t0 = performance.now();
  try {
    const r = await runOcr(file, true); // true=启用ROI
    $('first').value = r.first || '';
    $('second').value = r.second || '';
    $('third').value = r.third || '';
    $('special').value = r.special || '';
    $('consolation').value = r.consolation || '';
    $('preview').style.display = 'block';
    const dt = (performance.now()-t0).toFixed(0);
    $('status').textContent = `完成，用时 ${dt} ms`;
  } catch (e) {
    $('status').textContent = '识别失败，已回退到通用模式';
    try {
      const r2 = await runOcr(file, false);
      $('first').value = r2.first || '';
      $('second').value = r2.second || '';
      $('third').value = r2.third || '';
      $('special').value = r2.special || '';
      $('consolation').value = r2.consolation || '';
      $('preview').style.display = 'block';
    } catch (err) {
      $('status').textContent = '识别失败，请换更清晰截图或手动填入';
    }
  }
});
</script>
{% endblock %}

