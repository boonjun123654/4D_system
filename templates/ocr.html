{% extends "layout.html" %}
{% block content %}
<h2>ğŸ“· OCR è¯†åˆ«å½“æœŸæˆç»©ï¼ˆMagnumï¼‰</h2>

<div style="margin:12px 0; display:flex; gap:10px; align-items:center;">
  <label>å¼€å¥–æ—¥æœŸï¼š</label>
  <input type="date" id="draw_date" required>
  <label>Marketï¼š</label>
  <select id="market" required>
    <option value="M">M</option>
    <option value="P">P</option>
    <option value="T">T</option>
    <option value="S">S</option>
    <option value="H">H</option>
    <option value="E">E</option>
    <option value="B">B</option>
    <option value="K">K</option>
    <option value="W">W</option>
  </select>
</div>

<input type="file" id="img" accept="image/*">
<button id="btnOcr" style="margin-left:8px;">å¼€å§‹è¯†åˆ«</button>
<span id="status" style="margin-left:10px;color:#666;"></span>

<div id="preview" style="margin-top:16px; display:none;">
  <h3>è¯†åˆ«ç»“æœé¢„è§ˆ</h3>
  <div style="display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:center;">
    <div>1st:</div> <input id="first" maxlength="4">
    <div>2nd:</div> <input id="second" maxlength="4">
    <div>3rd:</div> <input id="third" maxlength="4">
    <div>Special(10):</div> <input id="special" placeholder="2006,7652,5588,0653,3611,3357,8643,6444,3588,1762">
    <div>Consolation(10):</div> <input id="consolation" placeholder="7868,2714,5699,2317,9134,6564,9034,7952,2044,6534">
  </div>
  <button id="btnSave" style="margin-top:12px;">ä¿å­˜åˆ°æ•°æ®åº“</button>
</div>

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const $ = (id) => document.getElementById(id);

function only4d(arr){
  // åªä¿ç•™4ä½çº¯æ•°å­—
  return arr.map(s => (s||'').replace(/\D/g,'')).filter(s => s.length===4);
}
function normList(arr, need=10){
  // å–å‰ need ä¸ªï¼Œæ‹¼æˆâ€œé€—å·+æ— ç©ºæ ¼â€
  const a = only4d(arr).slice(0, need);
  return a.join(',');
}
function extractByHeuristics(fullText){
  // ç»Ÿä¸€å¤§å°å†™ä¸åˆ†éš”
  const text = fullText.replace(/\s+/g,' ').trim();

  // é€šç”¨ï¼šå…ˆæŠ“åˆ°æ‰€æœ‰4ä½æ•°
  const all4d = text.match(/\b\d{4}\b/g) || [];

  // å°è¯•ä»å…³é”®è¯é™„è¿‘æå–
  function near(label, n=1){
    const i = text.toLowerCase().indexOf(label.toLowerCase());
    if(i<0) return [];
    // åœ¨å…³é”®è¯é™„è¿‘æŠ“æœ€å¤š n ä¸ª 4ä½æ•°
    const around = text.slice(Math.max(0,i-120), i+200);
    return (around.match(/\b\d{4}\b/g) || []).slice(0, n);
  }

  let first  = near('1st',1)[0]  || near('1 st',1)[0];
  let second = near('2nd',1)[0]  || near('2 nd',1)[0];
  let third  = near('3rd',1)[0]  || near('3 rd',1)[0];

  // å¦‚æœå…³é”®å­—ç­–ç•¥å¤±è´¥ï¼Œå°±æŒ‰å…¨å±€é¡ºåºå…œåº•
  if(!first || !second || !third){
    if(all4d.length >= 3){
      first  = first  || all4d[0];
      second = second || all4d[1];
      third  = third  || all4d[2];
    }
  }

  // Special/Consolation
  const specialBlockIdx = text.toLowerCase().indexOf('special');
  const consolBlockIdx  = text.toLowerCase().indexOf('consolation');

  let specials = [], consols = [];
  if(specialBlockIdx>=0){
    const seg = text.slice(specialBlockIdx, consolBlockIdx>0?consolBlockIdx:specialBlockIdx+800);
    specials = seg.match(/\b\d{4}\b/g) || [];
  }
  if(consolBlockIdx>=0){
    const seg = text.slice(consolBlockIdx, consolBlockIdx+800);
    consols = seg.match(/\b\d{4}\b/g) || [];
  }

  // å…œåº•ï¼šå¦‚æœ special/consolation ä¸å¤Ÿï¼Œä»å‰©ä½™å·ç ä¸­è¡¥é½ï¼ˆä½†ä¸ä¸ 1/2/3 é‡å¤ï¼‰
  const used = new Set([first, second, third].filter(Boolean));
  const rest = all4d.filter(x => !used.has(x));

  if(specials.length < 10){
    const add = rest.filter(x => specials.indexOf(x)<0).slice(0, 10 - specials.length);
    specials = specials.concat(add);
  }
  if(consols.length < 10){
    const used2 = new Set([...used, ...specials]);
    const add = rest.filter(x => !used2.has(x)).slice(0, 10 - consols.length);
    consols = consols.concat(add);
  }

  return {
    first: first || '',
    second: second || '',
    third: third || '',
    special: normList(specials, 10),
    consolation: normList(consols, 10),
  };
}

$('btnOcr').addEventListener('click', async () => {
  const file = $('img').files?.[0];
  if(!file){ alert('è¯·å…ˆé€‰æ‹©å¼€å¥–æˆªå›¾'); return; }
  if(!$('draw_date').value){ alert('è¯·é€‰æ‹©å¼€å¥–æ—¥æœŸ'); return; }

  $('status').textContent = 'è¯†åˆ«ä¸­â€¦(å–å†³äºå›¾ç‰‡æ¸…æ™°åº¦)';
  const worker = await Tesseract.createWorker('eng', 1, { logger: m => {} });
  const { data: { text } } = await worker.recognize(file);
  await worker.terminate();

  const result = extractByHeuristics(text);
  $('first').value = result.first;
  $('second').value = result.second;
  $('third').value = result.third;
  $('special').value = result.special;           // é€—å·+æ— ç©ºæ ¼
  $('consolation').value = result.consolation;   // é€—å·+æ— ç©ºæ ¼

  $('preview').style.display = 'block';
  $('status').textContent = 'è¯†åˆ«å®Œæˆï¼Œè¯·æ ¸å¯¹åä¿å­˜';
});

$('btnSave').addEventListener('click', async () => {
  const payload = {
    date: $('draw_date').value,
    market: $('market').value,
    first: $('first').value.trim(),
    second: $('second').value.trim(),
    third: $('third').value.trim(),
    special: $('special').value.replace(/\s+/g,''),         // ä¿è¯æ— ç©ºæ ¼
    consolation: $('consolation').value.replace(/\s+/g,'')  // ä¿è¯æ— ç©ºæ ¼
  };
  // åŸºæœ¬æ ¡éªŒ
  const is4 = s => /^\d{4}$/.test(s);
  if(!is4(payload.first) || !is4(payload.second) || !is4(payload.third)){
    alert('1st/2nd/3rd å¿…é¡»ä¸º4ä½æ•°å­—'); return;
  }
  const sp = payload.special.split(',').filter(Boolean);
  const co = payload.consolation.split(',').filter(Boolean);
  if(sp.length!==10 || co.length!==10 || sp.some(x=>!is4(x)) || co.some(x=>!is4(x))){
    alert('Special/Consolation å¿…é¡»å„10ä¸ª4ä½æ•°ï¼Œé€—å·åˆ†éš”ä¸”æ— ç©ºæ ¼'); return;
  }

  const res = await fetch('/admin/save_draw', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(data.ok){
    alert('âœ… ä¿å­˜æˆåŠŸ');
  }else{
    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'unknown'));
  }
});
</script>
{% endblock %}

